---
import {
  getMarkdownGists,
  getCommentsByGist,
  getGistPaths,
} from '@/utils/services'
import { unified } from 'unified'
import remarkParse from 'remark-parse'
import remarkRehype from 'remark-rehype'
import rehypeStringify from 'rehype-stringify'
import rehypeRaw from 'rehype-raw'
import Layout from '@/layouts/BlogPost.astro'

// Helper function to format dates as "7 Oct 2024"
function formatDate(dateString: string): string {
  const date = new Date(dateString)
  const day = date.getDate()
  const month = date.toLocaleString('default', { month: 'short' })
  const year = date.getFullYear()
  return `${day} ${month} ${year}`
}

// Helper function to render markdown to HTML
async function renderMarkdown(content: string): Promise<string> {
  const result = await unified()
    .use(remarkParse)
    .use(remarkRehype, { allowDangerousHtml: true })
    .use(rehypeRaw) // Added to preserve raw HTML
    .use(rehypeStringify)
    .process(content)
  return result.toString()
}

// Define the correct return type for getStaticPaths with properly formatted return value
export async function getStaticPaths() {
  const markdownFileNames = await getGistPaths()

  // Return the correct format - each fileName should be a simple string
  return markdownFileNames.map((fileName) => ({
    params: { slug: fileName },
  }))
}

// Correctly access the slug parameter
const { slug } = Astro.params

// Type guard to ensure slug is defined
if (!slug) {
  return Astro.redirect('/404')
}

const markdownGists = await getMarkdownGists()
const article = markdownGists.find((gist) => gist.markdownFileName === slug)

// Handle 404 case
if (!article) {
  return Astro.redirect('/404')
}

const comments = await getCommentsByGist(article)

// Process all comment bodies to convert markdown to HTML
const processedComments = await Promise.all(
  comments.map(async (comment) => ({
    ...comment,
    renderedBody: await renderMarkdown(comment.body),
  })),
)

// Format the date in the desired format
const formattedDate = formatDate(article.created_at)

// Create frontmatter object to pass to the Layout
const frontmatter = {
  title: article.description,
  pubDate: formattedDate,
}

// Also process the main article content
const renderedArticleContent = await renderMarkdown(
  article.markdownContent || '',
)
---

<Layout frontmatter={frontmatter}>
  <!-- The post content goes here, which will be placed in the slot of the Layout -->
  <div class="mb-6">
    <!-- Apply proper styling to ensure content renders correctly -->
    <div
      class="prose max-w-none dark:prose-invert"
      set:html={renderedArticleContent}
    />
  </div>

  {
    comments.length > 0 && (
      <div class="my-10">
        <h2 class="mb-6 text-2xl font-bold">Comments</h2>

        <div class="space-y-6">
          {processedComments.map((comment) => (
            <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
              <div class="mb-4 flex items-center">
                <img
                  src={`https://github.com/${comment.user.login}.png`}
                  alt={comment.user.login}
                  class="mr-4 h-10 w-10 rounded-full"
                />
                <div>
                  <div class="font-semibold text-text dark:text-darkText">
                    {comment.user.login}
                  </div>
                  <div class="text-sm text-gray-500">
                    {formatDate(comment.created_at)}
                  </div>
                </div>
              </div>
              <div
                class="prose max-w-none dark:prose-invert"
                set:html={comment.renderedBody}
              />
            </div>
          ))}
        </div>
      </div>
    )
  }
</Layout>
